# DefectDojo Docker Compose - Iron City IT
# Deploy: docker-compose up -d
# Access: https://defectdojo.ironcityit.com

version: '3.8'

services:
  nginx:
    image: defectdojo/defectdojo-nginx:latest
    depends_on:
      - uwsgi
    ports:
      - "8080:8080"
    environment:
      NGINX_METRICS_ENABLED: "false"
    volumes:
      - defectdojo_media:/usr/share/nginx/html/media
    restart: unless-stopped

  uwsgi:
    image: defectdojo/defectdojo-django:latest
    depends_on:
      - postgres
    entrypoint: ['/wait-for-it.sh', 'postgres:5432', '-t', '30', '--', '/entrypoint-uwsgi.sh']
    environment:
      DD_DEBUG: "False"
      DD_DJANGO_METRICS_ENABLED: "False"
      DD_ALLOWED_HOSTS: "*"
      DD_DATABASE_URL: "postgresql://defectdojo:defectdojo@postgres:5432/defectdojo"
      DD_CELERY_BROKER_URL: "redis://redis:6379/0"
      DD_SECRET_KEY: "${DD_SECRET_KEY:-change-me-in-production-use-long-random-string}"
      DD_CREDENTIAL_AES_256_KEY: "${DD_CREDENTIAL_AES_256_KEY:-change-me-32-char-key-here!!!!!}"
    volumes:
      - defectdojo_media:/app/media
    restart: unless-stopped

  celerybeat:
    image: defectdojo/defectdojo-django:latest
    depends_on:
      - postgres
      - redis
    entrypoint: ['/wait-for-it.sh', 'postgres:5432', '-t', '30', '--', '/entrypoint-celery-beat.sh']
    environment:
      DD_DATABASE_URL: "postgresql://defectdojo:defectdojo@postgres:5432/defectdojo"
      DD_CELERY_BROKER_URL: "redis://redis:6379/0"
      DD_SECRET_KEY: "${DD_SECRET_KEY:-change-me-in-production-use-long-random-string}"
    restart: unless-stopped

  celeryworker:
    image: defectdojo/defectdojo-django:latest
    depends_on:
      - postgres
      - redis
    entrypoint: ['/wait-for-it.sh', 'postgres:5432', '-t', '30', '--', '/entrypoint-celery-worker.sh']
    environment:
      DD_DATABASE_URL: "postgresql://defectdojo:defectdojo@postgres:5432/defectdojo"
      DD_CELERY_BROKER_URL: "redis://redis:6379/0"
      DD_SECRET_KEY: "${DD_SECRET_KEY:-change-me-in-production-use-long-random-string}"
    restart: unless-stopped

  initializer:
    image: defectdojo/defectdojo-django:latest
    depends_on:
      - postgres
    entrypoint: ['/wait-for-it.sh', 'postgres:5432', '--', '/entrypoint-initializer.sh']
    environment:
      DD_DATABASE_URL: "postgresql://defectdojo:defectdojo@postgres:5432/defectdojo"
      DD_ADMIN_USER: "admin"
      DD_ADMIN_MAIL: "admin@ironcityit.com"
      DD_ADMIN_FIRST_NAME: "Admin"
      DD_ADMIN_LAST_NAME: "User"
      DD_INITIALIZE: "true"
      DD_SECRET_KEY: "${DD_SECRET_KEY:-change-me-in-production-use-long-random-string}"

  postgres:
    image: postgres:14-alpine
    environment:
      POSTGRES_DB: defectdojo
      POSTGRES_USER: defectdojo
      POSTGRES_PASSWORD: defectdojo
    volumes:
      - defectdojo_postgres:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped

volumes:
  defectdojo_media:
  defectdojo_postgres:
